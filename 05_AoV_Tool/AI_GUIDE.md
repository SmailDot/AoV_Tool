# AI Agent 指南：NKUST AoV Tool

> **這不是給人類看的 README，這是給你（未來的 AI Agent）看的交接文件。**
> 當你接手這個專案時，請先閱讀此文件，了解專案的靈魂、架構與潛在坑點。

## 1. 專案靈魂 (Project Identity)
*   **名稱**: NKUST AoV Tool (Algorithm on Vision / FPGA)
*   **定位**: 電腦視覺演算法的「快速原型設計」與「FPGA 資源估算」工具。
*   **核心價值**: 讓不懂 OpenCV 的人能用自然語言設計 Pipeline，並讓不懂 FPGA 的人知道這個演算法會消耗多少資源。
*   **主要開發者**: Sisyphus (你我他)。

## 2. 架構地圖 (Architecture Map)

專案採用 **Streamlit (UI) + OpenCV (Engine) + LLM (Brain)** 的三層架構。

```
05_AoV_Tool/
├── aov_app.py              # [UI] 入口點。只負責 Layout 與 Session State 管理。
├── logic_engine.py         # [Brain] LLM 通訊 (OpenAI/Google)、Prompt 工程、DAG 解析。
├── processor.py            # [Muscle] 執行引擎。負責調度演算法，本身不含邏輯。
├── library_manager.py      # [Data] 讀寫 tech_lib.json，負責演算法的 CRUD。
├── tech_lib.json           # [DB] 演算法的規格書、參數定義、FPGA 資源表。
│
├── app/vision/ops/         # [Kernels] 真正的 OpenCV 實作放在這裡！
│   ├── basic.py            # 模糊、縮放
│   ├── edge.py             # Canny, Sobel
│   ├── detect.py           # Hough, HOG, Advanced Coin
│   ├── merge.py            # Add, Blend (多輸入支援)
│   └── custom/             # 未來擴充用目錄
│
└── components/             # [UI Components] 側邊欄、節點編輯器、視覺化圖表。
```

## 3. 關鍵機制 (Critical Mechanisms)

### 3.1. 雙通道 LLM (Dual-Core LLM)
*   **邏輯**: `LogicEngine` 會檢查 Base URL。
*   **OpenAI 通道**: 用於 OpenAI, Groq, DeepSeek。使用 `openai` 套件。
*   **Google 原生通道**: 用於 Gemini。**必須**使用 `google.generativeai` 套件，避開相容層的 404 Bug。

### 3.2. 有狀態執行 (Stateful Execution)
*   **問題**: 靜態圖片 vs 動態影片。
*   **解法**: `processor.execute_pipeline(..., context={})`。
*   **實作**: 演算法 (如 `op_advanced_coin_logic`) 會檢查 `context`。
    *   若 `context` 為空 -> 單張圖模式 (Instant)。
    *   若 `context` 有值 -> 影片模式 (Accumulate)。

### 3.3. 模組化 Ops (Refactored Ops)
*   不要把邏輯寫在 `processor.py`！
*   去 `app/vision/ops` 找對應的分類檔案。
*   寫完後，記得去 `processor.py` 的 `operation_map` 註冊。

### 3.4. 繁體中文優先
*   `PromptMaster` 被強制要求使用 **Traditional Chinese (Taiwan)** 進行 Reasoning。
*   `tech_lib.json` 的 `name_zh` 欄位用於 UI 顯示。

## 4. 常見坑點 (Known Issues & Fixes)

| 症狀 | 原因 | 解法 |
|------|------|------|
| **Sidebar 消失** | `tech_lib.json` 格式壞了，導致 `LibraryManager` 載入失敗。 | 檢查 JSON 結尾是否有多餘逗號。程式已有 Fallback 機制。 |
| **Model Not Found (404)** | Google Gemini 的 OpenAI 相容層掛了，或是模型改名了。 | 切換到 Google 原生通道 (已自動化)。使用 `gemini-2.0-flash-exp`。 |
| **Proxy Error** | `openai` 與 `httpx` 版本衝突。 | `pip install -U openai httpx`。 |
| **Unknown Operation** | 新增了 Op 但忘記在 `processor.py` 註冊。 | 去 `processor.py` 的 `__init__` 補上。 |

## 5. 未來擴充指南 (Future Roadmap)

如果你要...
1.  **新增演算法**:
    *   寫在 `app/vision/ops/custom/my_algo.py`。
    *   在 `tech_lib.json` 加入 Metadata。
    *   在 `processor.py` 註冊。
2.  **支援影片上傳**:
    *   在 `aov_app.py` 新增 `st.video_uploader`。
    *   撰寫一個迴圈，重複呼叫 `processor.execute_pipeline(frame, context=state)`。
3.  **優化 Prompt**:
    *   修改 `logic_engine.py` 中的 `SYSTEM_PROMPT`。

---
*Generated by Sisyphus (2026-01-20)*
