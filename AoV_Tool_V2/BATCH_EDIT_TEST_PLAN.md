# 批量修改功能測試計劃

## 測試環境
- Python 3.8+
- Streamlit (最新版)
- 瀏覽器: Chrome/Firefox

## 測試準備
1. 啟動應用程式: `streamlit run aov_app.py`
2. 準備測試圖片: `test1.jpg` 或 `test2.jpg`

---

## 測試案例 1: 暫存區機制

### 測試步驟
1. 上傳圖片並執行辨識
2. 在 A-B-C 表單中:
   - A: 選擇「新增」
   - B: 選擇一個製程 (例如: C01-雷射切割)
   - C: 輸入理由「測試新增操作」
3. 點擊「▶️ 執行」

### 預期結果
- ✅ 理由欄位自動清空
- ✅ 「待確認區」出現綠色標籤，顯示「➕ 新增 [C01] 雷射切割 (測試新增操作)」
- ✅ 當前製程清單**不變**
- ✅ 頁面無卡頓

---

## 測試案例 2: 連續操作

### 測試步驟
1. 繼續在表單中:
   - 新增 C02-折彎 (理由: 測試批量新增)
   - 移除 F01-繪圖者 (理由: 測試移除操作)
   - 新增 C03-雷射焊接 (無理由)

### 預期結果
- ✅ 待確認區顯示 4 個操作
- ✅ 綠色標籤顯示新增操作 (3個)
- ✅ 紅色標籤顯示移除操作 (1個)
- ✅ 無理由的操作不顯示理由文字
- ✅ 每次執行後理由欄位清空

---

## 測試案例 3: 撤銷操作

### 測試步驟
1. 點擊第 2 個操作的「❌」按鈕 (C02-折彎)
2. 點擊第 1 個操作的「❌」按鈕 (C01-雷射切割)

### 預期結果
- ✅ 對應操作從待確認區消失
- ✅ 剩餘操作重新排序
- ✅ 待確認區顯示「共有 2 個待處理操作」

---

## 測試案例 4: 信心度調整

### 測試步驟
1. 在當前製程清單中:
   - 找到一個製程 (例如: F01-繪圖者)
   - 調整信心度滑桿 (例如: 從 95% 調到 60%)
2. 再調整另一個製程的信心度 (例如: G01-剪板機 調到 80%)

### 預期結果
- ✅ 滑桿旁的百分比即時更新
- ✅ 標籤顏色根據信心度變化:
  - ≥70%: 綠色 (青綠底色)
  - 50-70%: 橙色 (橙色底色)
  - <50%: 紅色 (紅色底色)
- ✅ 無頁面 rerun (流暢操作)

---

## 測試案例 5: 批量提交

### 測試步驟
1. 確認待確認區有 2 個操作 (F01-移除, C03-新增)
2. 確認信心度已調整
3. 點擊「✅ 定案並學習」

### 預期結果
- ✅ 顯示 Toast: "✅ 已批量保存並學習"
- ✅ 待確認區清空
- ✅ 當前製程清單更新:
  - F01-繪圖者 被移除
  - C03-雷射焊接 被新增 (100% 信心度)
  - 其他製程的信心度保持調整後的值
- ✅ 標題變更為「📋 人工校正所需製程為以下」

---

## 測試案例 6: 重複操作防呆

### 測試步驟
1. 在表單中選擇「新增 C03-雷射焊接」
2. 點擊「▶️ 執行」

### 預期結果
- ✅ 顯示警告: "⚠️ C03 的 add 操作已在待確認區" (如果已在暫存區)
- ✅ 或顯示警告: "⚠️ C03 已存在於清單中" (如果已在當前清單)
- ✅ 不會新增重複項目

---

## 測試案例 7: 知識庫寫入驗證

### 測試步驟
1. 完成一次批量提交後
2. 檢查 `knowledge_db.json`
3. 找到最新條目 (最後一筆)

### 預期結果
- ✅ `correct_processes` 包含所有最終製程 ID
- ✅ `reasoning` 包含:
  - 原始辨識的理由
  - `[ADD] C03: (人工新增)` (如果有新增操作)
  - `[REMOVE] F01: 測試移除操作` (如果有移除操作)
- ✅ 每個製程的信心度已更新

---

## 測試案例 8: 撤回功能

### 測試步驟
1. 完成一次批量提交後
2. 點擊「↩️ 撤回」

### 預期結果
- ✅ 顯示 Toast: "已撤回最近一次學習"
- ✅ 知識庫中該條目被刪除
- ✅ `last_kb_entry_id` 清空

---

## 性能測試

### 測試步驟
1. 連續執行 10 次「新增/移除」操作
2. 觀察頁面反應速度

### 預期結果
- ✅ 每次操作響應時間 < 200ms
- ✅ 無明顯卡頓或延遲
- ✅ 待確認區流暢更新
- ✅ 理由欄位每次清空無延遲

---

## 邊界測試

### 測試案例 9: 空清單批量提交
1. 移除所有製程 (清單為空)
2. 點擊「✅ 定案並學習」

**預期**: 仍可保存 (empty list)

### 測試案例 10: 只有信心度調整
1. 不添加任何待確認操作
2. 只調整現有製程的信心度
3. 點擊「✅ 定案並學習」

**預期**: 信心度變更被保存

### 測試案例 11: 撤銷所有待確認操作
1. 新增 5 個操作到待確認區
2. 逐一點擊「❌」撤銷所有操作
3. 待確認區消失

**預期**: 待確認區完全清空，不顯示

---

## 回歸測試 (確保舊功能正常)

### 測試案例 12: OCR/幾何/符號辨識
- ✅ 三種特徵提取仍正常運作
- ✅ 診斷資訊正常顯示

### 測試案例 13: 重複圖片檢測
- ✅ 上傳重複圖片時仍提示相似條目
- ✅ 覆蓋/並存/取消按鈕正常運作

### 測試案例 14: RAG 參考
- ✅ 如啟用 RAG，仍顯示參考案例

---

## 已知問題 & TODO

### 已完成 ✅
- [x] 暫存區機制 (pending_changes)
- [x] 待確認區 UI
- [x] 彩色標籤渲染
- [x] 信心度滑桿
- [x] 理由欄位自動清空
- [x] 批量提交邏輯
- [x] pending_changes 清空機制
- [x] 移除舊的 rag_feedback_queue

### 待改進 (Optional)
- [ ] 待確認區支援拖曳排序
- [ ] 批量導入/導出製程清單
- [ ] 撤銷/重做堆疊 (Undo/Redo Stack)
- [ ] 鍵盤快捷鍵 (Ctrl+Enter 提交)

---

## 測試報告模板

```
測試日期: YYYY-MM-DD
測試人員: [姓名]
測試環境: [OS, Python版本, Streamlit版本]

| 測試案例 | 狀態 | 備註 |
|---------|------|------|
| 案例 1  | ✅ PASS | 無異常 |
| 案例 2  | ✅ PASS | 無異常 |
| 案例 3  | ❌ FAIL | [具體錯誤描述] |
| ...     | ...    | ... |

總結: 
- 通過率: X/Y (X%)
- 主要問題: [列出]
- 建議: [列出]
```

---

**測試完成後請回報結果！**
