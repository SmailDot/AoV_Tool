# 多語言 OCR 與父圖注意事項功能 - 測試指南

> **版本**: 2.1.1  
> **日期**: 2026-02-03  
> **狀態**: ✅ UI 整合完成，待實際測試

---

## 📋 功能概述

### 已實現功能
1. ✅ **多語言 OCR 支援** - 中文(繁簡)、英文、日文、韓文
2. ✅ **父圖注意事項提取** - 自動掃描標題欄區域
3. ✅ **重要事項過濾** - 偵測警告/注意/要求等關鍵字
4. ✅ **UI 整合顯示** - Streamlit 介面完整呈現
5. ✅ **診斷資訊整合** - 父圖上下文資訊顯示

### 功能流程
```
使用者上傳父圖 + 子圖
    ↓
系統掃描父圖標題欄 (右下角 25%)
    ↓
多語言 OCR 辨識 (中英日韓)
    ↓
過濾重要注意事項 (關鍵字匹配)
    ↓
UI 顯示重要提醒 (製程預測結果前)
    ↓
防止使用者遺漏父圖要求
```

---

## 🚀 快速測試步驟

### 前置準備

#### 1. 確認環境
```bash
cd "D:\NKUST_LAB_Work_Data\Lab work\cv-algorithm-study\AoV_Tool_V2"

# 檢查 Python 版本 (需 3.8+)
python --version

# 檢查虛擬環境
.venv\Scripts\activate  # Windows
```

#### 2. (選填) 安裝 PaddlePaddle
```bash
# 如果需要實際 OCR 功能，安裝 PaddlePaddle
pip install paddlepaddle==2.6.1 -i https://mirror.baidu.com/pypi/simple

# 如果不安裝，系統會使用模擬模式 (功能仍可測試)
```

---

## 🧪 測試場景

### 場景 1: 基本功能測試 (不需 OCR)

**目標**: 驗證 UI 結構正確顯示

**步驟**:
1. 啟動應用程式
   ```bash
   streamlit run aov_app.py
   ```

2. 上傳任意父圖 + 子圖
   - 父圖: 任何工程圖紙 (不一定要有文字)
   - 子圖: 任何工程圖紙

3. 關閉 OCR 選項 (避免錯誤)
   - ❌ OCR 文字辨識 (不勾選)
   - ✅ 幾何特徵分析
   - ✅ 符號辨識

4. 點擊「開始辨識製程」

**預期結果**:
- ✅ 辨識完成，無錯誤
- ✅ 右側顯示製程預測結果
- ✅ 不顯示父圖注意事項 (因為 OCR 關閉)
- ✅ 診斷資訊中無父圖上下文資訊

---

### 場景 2: 完整功能測試 (需安裝 PaddlePaddle)

**目標**: 驗證多語言 OCR 與注意事項提取

**步驟**:
1. 確認已安裝 PaddlePaddle
   ```bash
   python -c "import paddle; print('PaddlePaddle 版本:', paddle.__version__)"
   ```

2. 準備測試圖片 (自行製作或使用現有工程圖)
   - **父圖**: 包含標題欄文字 (右下角)
   - **文字內容**: 混合中英日韓文
   - **關鍵字**: 包含「注意」「警告」「要求」等

3. 啟動應用程式
   ```bash
   streamlit run aov_app.py
   ```

4. 上傳父圖與子圖
   - 父圖: 包含多語言注意事項的工程圖
   - 子圖: 任何工程圖紙

5. 啟用 OCR 選項
   - ✅ OCR 文字辨識 (勾選)
   - ✅ 幾何特徵分析
   - ✅ 符號辨識

6. 點擊「開始辨識製程」

**預期結果**:
- ✅ 辨識完成，無錯誤
- ✅ 顯示父圖注意事項區塊 (⚠️ 父圖重要注意事項)
- ✅ 顯示檢測到的語言 (🌐 檢測到語言: ...)
- ✅ 顯示重要提醒事項 (每條前有圖示 🚫/⚠️/✓)
- ✅ 可展開查看標題欄完整內容 (📋 查看標題欄完整內容)
- ✅ 診斷資訊包含父圖上下文資訊

**UI 範例**:
```
┌─────────────────────────────────────────────┐
│ ⚠️ 父圖重要注意事項                          │
├─────────────────────────────────────────────┤
│ 🌐 檢測到語言: 繁體中文, 英文               │
│                                             │
│ 重要提醒事項:                               │
│ ⚠️ 注意: 無塵室等級 Class 100              │
│ 🚫 警告: 不可使用鉻酸鹽                     │
│ ✓ 要求: 三價鉻鈍化處理                      │
│                                             │
│ ▼ 📋 查看標題欄完整內容                     │
│   材質: SUS304                              │
│   厚度: T1.5                                │
│   表面處理: 鈍化                            │
└─────────────────────────────────────────────┘
```

---

### 場景 3: 診斷資訊驗證

**目標**: 確認父圖上下文資訊正確記錄

**步驟**:
1. 完成場景 2 的辨識
2. 展開「診斷資訊 (Diagnostics)」
3. 向下捲動查看

**預期結果**:
- ✅ 顯示「父圖上下文資訊」區塊
- ✅ 包含以下欄位 (如果有檢測到):
  - `材質`: 檢測到的材質名稱
  - `客戶`: 檢測到的客戶名稱
  - `檢測語言`: ["chinese_cht", "en", "japan", "korean"]
  - `重要注意事項數量`: 整數
  - `標題欄文字數量`: 整數

**範例 JSON**:
```json
{
  "材質": "白鐵",
  "客戶": "ASML",
  "檢測語言": ["chinese_cht", "en"],
  "重要注意事項數量": 3,
  "標題欄文字數量": 8
}
```

---

## 📸 測試圖片製作建議

### 父圖測試圖片要求

#### 基本要求
- **格式**: JPG, PNG, BMP
- **解析度**: 300 DPI 以上
- **背景**: 白底黑線 (標準工程圖)
- **標題欄位置**: 右下角區域

#### 文字內容建議
在右下角標題欄包含以下範例文字:

```
材質: SUS304 / Material: Stainless Steel

注意事項 / Notes:
⚠️ 注意: 無塵室等級 Class 100 (Cleanroom Level)
🚫 警告: 不可使用鉻酸鹽 (Do NOT use Chromate)
✓ 要求: 三價鉻鈍化處理 (Trivalent Chromium Passivation Required)

特殊要求:
- 表面粗糙度 Ra ≤ 0.8
- 清潔度要求: ISO 14644-1 Class 5
- 包裝: 真空包裝 (Vacuum Packaging)
```

#### 多語言混合範例
```
品質要求 / Quality Requirements / 品質要求 / 품질 요구사항

⚠️ 注意 (Caution / 注意 / 주의):
- 禁止使用研磨劑 (No Abrasives / 研磨剤禁止 / 연마제 금지)
- 必須配戴手套 (Gloves Required / 手袋必須 / 장갑 착용 필수)

★ 重要提醒: 此零件為客戶特殊規格，不得替代
★ Important: This is customer-specific, no substitution allowed
```

---

## 🔍 驗證檢查清單

### 功能驗證

- [ ] **UI 顯示正常**
  - [ ] 父圖注意事項區塊出現
  - [ ] 語言標記正確顯示
  - [ ] 圖示正確 (🚫/⚠️/✓)
  - [ ] 可展開標題欄內容

- [ ] **OCR 辨識準確**
  - [ ] 繁體中文正確辨識
  - [ ] 英文正確辨識
  - [ ] 日文正確辨識 (如果有)
  - [ ] 韓文正確辨識 (如果有)

- [ ] **關鍵字過濾正確**
  - [ ] 「注意」關鍵字被提取
  - [ ] 「警告」關鍵字被提取
  - [ ] 「要求」關鍵字被提取
  - [ ] 無關文字被過濾

- [ ] **診斷資訊完整**
  - [ ] 父圖上下文資訊顯示
  - [ ] 材質/客戶資訊正確
  - [ ] 檢測語言列表正確
  - [ ] 數量統計正確

### 錯誤處理驗證

- [ ] **無父圖情況**
  - [ ] 不顯示注意事項區塊
  - [ ] 辨識正常進行
  - [ ] 無錯誤訊息

- [ ] **OCR 關閉情況**
  - [ ] 不顯示注意事項區塊
  - [ ] 辨識正常進行
  - [ ] 無錯誤訊息

- [ ] **無文字父圖**
  - [ ] 不顯示注意事項區塊
  - [ ] 辨識正常進行
  - [ ] 無錯誤訊息

- [ ] **PaddlePaddle 未安裝**
  - [ ] 顯示友善錯誤訊息
  - [ ] 建議關閉 OCR 或安裝套件
  - [ ] 不影響其他功能

---

## 🐛 已知問題與限制

### 1. OCR 準確度
**問題**: OCR 可能誤讀相似字元 (如 0/O, 1/l, 8/B)

**影響**: 注意事項文字可能不完全準確

**緩解方案**:
- 提高圖片解析度 (300 DPI+)
- 使用清晰的掃描圖
- 人工確認重要文字

### 2. 標題欄位置假設
**問題**: 系統預設掃描右下角 25% 區域

**影響**: 非標準位置的標題欄可能無法完整掃描

**緩解方案**:
- 確保標題欄在右下角
- 未來可新增自訂掃描區域功能

### 3. 關鍵字覆蓋率
**問題**: 預設關鍵字清單可能不完整

**影響**: 某些重要注意事項可能未被過濾出來

**緩解方案**:
- 查看標題欄完整內容 (展開區塊)
- 未來可新增自訂關鍵字功能

### 4. 語言檢測重複
**問題**: 混合語言文字可能被多次檢測

**影響**: 同一文字可能出現多次

**緩解方案**:
- 已實作去重邏輯 (deduplication)
- 相同文字只顯示一次

---

## 📊 效能指標

### 預期效能

| 項目 | 預期值 | 說明 |
|------|--------|------|
| OCR 處理時間 | 2-5 秒 | 每種語言約 0.5-1 秒 |
| 標題欄掃描時間 | < 1 秒 | 局部區域掃描 |
| 關鍵字過濾時間 | < 0.1 秒 | 純文字匹配 |
| 總額外時間 | 3-6 秒 | 相比無父圖模式 |

### 記憶體使用

| 元件 | 記憶體使用 | 說明 |
|------|-----------|------|
| PaddleOCR 引擎 | ~500 MB | 每個語言模型 |
| 多語言緩存 | 懶加載 | 只載入使用的語言 |
| 圖片暫存 | ~50 MB | 父圖 + 子圖 |

---

## 🔧 疑難排解

### 問題 1: PaddlePaddle 安裝失敗

**症狀**: `pip install paddlepaddle` 失敗

**解決方案**:
```bash
# 使用中國鏡像 (更快)
pip install paddlepaddle==2.6.1 -i https://mirror.baidu.com/pypi/simple

# 如果仍失敗，使用官方源
pip install paddlepaddle==2.6.1 -f https://www.paddlepaddle.org.cn/whl/windows/mkl/avx/stable.html

# Linux/Mac
pip install paddlepaddle==2.6.1
```

---

### 問題 2: OCR 功能無作用

**症狀**: 勾選 OCR，但無注意事項顯示

**檢查清單**:
1. 確認已上傳父圖
2. 確認 PaddlePaddle 已安裝
3. 父圖右下角有文字
4. 文字包含關鍵字 (注意/警告/要求)

**驗證方法**:
```python
# 在 Python 環境測試
import paddle
print(paddle.__version__)  # 應顯示版本號

from paddleocr import PaddleOCR
ocr = PaddleOCR(use_angle_cls=True, lang='chinese_cht')
print("PaddleOCR 初始化成功")
```

---

### 問題 3: 辨識結果不正確

**症狀**: 檢測到錯誤文字或遺漏文字

**可能原因**:
1. 圖片解析度太低
2. 文字模糊或反光
3. 字體過小
4. 語言選擇不正確

**改善方法**:
1. 使用 300 DPI 以上掃描
2. 確保照明均勻
3. 放大標題欄區域
4. 檢查診斷資訊中的檢測語言

---

### 問題 4: UI 顯示錯誤

**症狀**: 父圖注意事項區塊未出現

**檢查清單**:
1. 確認辨識成功完成
2. 檢查診斷資訊是否有父圖上下文
3. 查看控制台錯誤訊息
4. 確認 `result.parent_context` 不為空

**除錯方法**:
```python
# 在 Streamlit 除錯
result = st.session_state.recognition_result
if result and result.parent_context:
    st.write("父圖上下文存在")
    st.write("重要注意事項:", result.parent_context.important_notes)
    st.write("檢測語言:", result.parent_context.detected_languages)
else:
    st.write("父圖上下文不存在")
```

---

## 📞 回報問題

### 測試回報格式

當發現問題時，請提供以下資訊:

```
【測試環境】
- 作業系統: Windows 11 / Linux / macOS
- Python 版本: 3.x.x
- PaddlePaddle 版本: x.x.x (或未安裝)
- 圖片格式: JPG / PNG / BMP
- 圖片解析度: xxx DPI

【問題描述】
(詳細說明發生什麼問題)

【重現步驟】
1. 上傳父圖 (檔名: xxx.jpg)
2. 上傳子圖 (檔名: xxx.jpg)
3. 啟用 OCR
4. 點擊辨識
5. 觀察到: (問題現象)

【預期結果】
(應該要怎樣)

【實際結果】
(實際發生什麼)

【截圖】
(如果有的話)

【錯誤訊息】
(從診斷資訊或控制台複製)
```

---

## 📚 相關文件

- **README.md**: 系統使用手冊
- **MANUFACTURING.md**: 技術架構文件
- **DUAL_IMAGE_FEATURE.md**: 雙圖模式說明
- **app/manufacturing/extractors/ocr.py**: OCR 實作
- **app/manufacturing/extractors/parent_parser.py**: 父圖解析器
- **test_multilang_simple.py**: 結構測試腳本
- **test_multilang_ocr.py**: 完整 OCR 測試腳本

---

## ✅ 完成檢查清單

### 開發者檢查清單
- [x] 多語言 OCR 方法實作
- [x] 父圖解析器整合
- [x] 資料結構定義
- [x] UI 顯示區塊
- [x] 診斷資訊整合
- [x] 測試腳本撰寫
- [x] 文件更新
- [x] Git 提交 (中文訊息)

### 使用者測試清單
- [ ] 場景 1: 基本功能測試
- [ ] 場景 2: 完整功能測試
- [ ] 場景 3: 診斷資訊驗證
- [ ] 準備測試圖片
- [ ] 驗證 OCR 準確度
- [ ] 驗證關鍵字過濾
- [ ] 驗證 UI 顯示
- [ ] 回報測試結果

---

**祝測試順利！** 🎉

如有任何問題，請參考「疑難排解」章節或聯繫開發團隊。

---

**版本歷史**:
- v2.1.1 (2026-02-03): UI 整合完成，測試指南初版
- v2.1.0 (2026-02-03): 多語言 OCR 功能實作完成
