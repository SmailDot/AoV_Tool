# 測試指南 - 5個關鍵功能修復

## 測試環境準備

### 啟動應用程式
```bash
cd AoV_Tool_V2
streamlit run aov_app.py
```

### 測試圖片
- 使用 `test1.jpg` 或 `test2.jpg` (專案中已有)
- 或準備自己的工程圖紙 (建議 300 DPI 以上)

---

## 🧪 Task 1: RAG 獨立運作測試

### 目標
驗證 RAG 在 VLM 關閉時仍可正常工作

### 步驟
1. **設定側邊欄**:
   - ✅ 開啟知識庫輔助 (RAG)
   - ❌ 關閉 VLM (不勾選)
   - ✅ 開啟幾何特徵分析
   - ✅ 開啟符號辨識

2. **上傳圖片**: 選擇一張已保存到知識庫的圖片
   - 如果沒有，先上傳一張新圖片，執行辨識，保存到知識庫
   - 然後重新上傳同一張圖片

3. **執行辨識**: 點擊「開始辨識製程」

4. **驗證結果**:
   - ✅ 辨識應該正常完成 (無錯誤)
   - ✅ 向下捲動，展開「本次推論參考的歷史案例 (RAG Context)」
   - ✅ 應該顯示至少一個參考案例
   - ✅ 參考案例包含: 形狀描述、正確製程

### 預期結果
```
✅ 辨識完成！處理時間: 1.23 秒

當前製程清單:
- F01 - 焊接 (信心度: 75%)

▼ 本次推論參考的歷史案例 (RAG Context)
參考案例：...
正確製程：F01, D01
```

### 失敗情況
- ❌ 如果 RAG 區塊不顯示 → Task 1 失敗
- ❌ 如果出現 VLM 相關錯誤 → Task 1 失敗

---

## 🧪 Task 2: 多圖保存測試

### 目標
驗證上傳多張圖片時，所有圖片都被保存到知識庫

### 步驟
1. **上傳多張圖片**:
   - 點擊「上傳工程圖紙」
   - 選擇 3 張不同的圖片 (可以是 test1.jpg, test2.jpg 和其他)

2. **執行辨識**: 點擊「開始辨識製程」

3. **調整製程清單**:
   - 在「待確認動作」區塊
   - 調整製程 (加入、刪除、或保持原樣)

4. **保存到知識庫**:
   - 點擊「保存至知識庫」按鈕
   - 觀察成功訊息

5. **驗證結果**:
   - ✅ 成功訊息應顯示: "已保存至知識庫 (3 張圖片)"
   - ✅ 檢查 `knowledge_db.json`:
     ```bash
     notepad knowledge_db.json
     ```
     應包含最新條目，有 `additional_images` 欄位，包含 3 個路徑
   
   - ✅ 檢查 `knowledge_images/` 目錄:
     ```bash
     dir knowledge_images
     ```
     應該新增 3 張圖片 (檔名包含時間戳記)

### 預期結果
```json
// knowledge_db.json (最新條目)
{
  "id": "20260213_123456",
  "image_path": "knowledge_images/20260213_123456_tmp123abc.png",
  "additional_images": [
    "knowledge_images/20260213_123456_image1.png",
    "knowledge_images/20260213_123456_image2.png"
  ],
  ...
}
```

### 失敗情況
- ❌ 成功訊息顯示 "(1 張圖片)" → Task 2 失敗
- ❌ `additional_images` 欄位不存在或為空 → Task 2 失敗
- ❌ `knowledge_images/` 只有 1 張新圖片 → Task 2 失敗

---

## 🧪 Task 3: 無頁面重載測試

### 目標
驗證加入/刪除製程時，頁面不會完全重新載入

### 步驟
1. **執行辨識**: 上傳圖片，點擊「開始辨識製程」

2. **測試加入製程**:
   - 捲動到「待確認動作」區塊
   - 點擊「加入製程」按鈕
   - 從下拉清單選擇任一製程
   - **觀察頁面行為**:
     - ✅ 待確認清單應該**立即更新** (顯示新製程)
     - ✅ 頁面**不應該閃爍**或完全重載
     - ✅ 捲動位置應該保持 (不跳回頂部)

3. **測試刪除製程**:
   - 點擊任一製程旁的「刪除」按鈕
   - **觀察頁面行為**:
     - ✅ 該製程應該**立即消失**
     - ✅ 頁面**不應該閃爍**
     - ✅ 捲動位置應該保持

### 預期結果
- 流暢的 UI 更新，無明顯延遲
- 無頁面白屏或閃爍
- 捲動位置保持在當前區塊

### 失敗情況
- ❌ 頁面完全重載 (白屏閃爍) → Task 3 失敗
- ❌ 捲動位置跳回頂部 → Task 3 失敗
- ❌ 有明顯延遲 (>1 秒) → Task 3 部分失敗

---

## 🧪 Task 4: 手動輸入測試

### 目標
驗證手動輸入製程代碼/名稱功能，包括註冊未知製程

### 測試案例 1: 輸入已知代碼

**步驟**:
1. 執行辨識後，捲動到「待確認動作」
2. 點擊「加入製程」
3. 選擇 **「手動輸入代碼或名稱」** (單選按鈕)
4. 在文字框輸入: `f01` (小寫)
5. 按 Enter 或點擊旁邊的按鈕

**預期結果**:
- ✅ 顯示成功訊息: "已加入: F01 - 焊接" (或對應的製程名稱)
- ✅ 待確認清單中出現該製程

---

### 測試案例 2: 輸入已知名稱

**步驟**:
1. 點擊「加入製程」
2. 選擇 **「手動輸入代碼或名稱」**
3. 輸入: `鑽孔` (或任何已知的製程名稱)
4. 按 Enter

**預期結果**:
- ✅ 顯示成功訊息: "已加入: O01 - 鑽孔" (或對應的製程代碼)
- ✅ 待確認清單中出現該製程

---

### 測試案例 3: 輸入未知代碼 (需要名稱)

**步驟**:
1. 點擊「加入製程」
2. 選擇 **「手動輸入代碼或名稱」**
3. 輸入: `X99` (未知代碼)
4. 按 Enter

**預期結果**:
- ⚠️ 顯示警告: "未知製程: X99"
- 📝 顯示資訊: "請填寫完整資訊以註冊新製程"
- ✅ 顯示文字輸入框: "請輸入製程 X99 的中文名稱"
- ✅ 佔位符: "例如: 鑽孔"

**繼續步驟**:
5. 輸入名稱: `特殊加工`
6. 點擊「確認註冊」按鈕

**預期結果**:
- ✅ 顯示成功訊息: "已註冊並加入: X99 - 特殊加工"
- ✅ 待確認清單中出現該製程，標記為 "手動加入 (新製程)"

---

### 測試案例 4: 輸入未知名稱 (需要代碼)

**步驟**:
1. 點擊「加入製程」
2. 選擇 **「手動輸入代碼或名稱」**
3. 輸入: `雷射雕刻` (未知名稱)
4. 按 Enter

**預期結果**:
- ⚠️ 顯示警告: "未知製程: 雷射雕刻"
- 📝 顯示資訊: "請填寫完整資訊以註冊新製程"
- ✅ 顯示文字輸入框: "請輸入製程 '雷射雕刻' 的代碼"
- ✅ 佔位符: "例如: F01"

**繼續步驟**:
5. 輸入代碼: `L01`
6. 點擊「確認註冊」按鈕

**預期結果**:
- ✅ 顯示成功訊息: "已註冊並加入: L01 - 雷射雕刻"
- ✅ 待確認清單中出現該製程，標記為 "手動加入 (新製程)"

---

### 失敗情況
- ❌ 無法輸入文字 (文字框不顯示) → Task 4 失敗
- ❌ 輸入已知代碼/名稱後顯示 "未知製程" → 匹配邏輯失敗
- ❌ 註冊表單不顯示 → Task 4 失敗
- ❌ 點擊「確認註冊」後沒有加入清單 → Task 4 失敗

---

## 🧪 Task 5: 學習後確認對話框測試

### 目標
驗證保存到知識庫後，系統詢問是否重新辨識，並使用相同圖片和設定

### 前置條件
- **必須啟用 RAG** (這樣才能看到知識庫的效果)

### 步驟
1. **上傳圖片並辨識**:
   - 上傳 `test1.jpg` 或其他圖片
   - ✅ 啟用 RAG (重要！)
   - ✅ 啟用幾何特徵分析
   - ✅ 啟用符號辨識
   - 點擊「開始辨識製程」

2. **調整製程清單**:
   - 在「待確認動作」中調整製程
   - 例如: 加入 "F01 - 焊接", "D01 - 折彎"

3. **保存到知識庫**:
   - 點擊「保存至知識庫」按鈕
   - 觀察頁面變化

4. **驗證對話框顯示**:
   - ✅ 顯示成功訊息: "✅ 已成功保存至知識庫！"
   - ✅ 顯示提示: "💡 知識庫已更新，是否需要重新辨識以使用最新的知識庫？"
   - ✅ 顯示兩個按鈕: "🔄 是，重新辨識" (藍色) 和 "❌ 不需要"

5. **測試重新辨識**:
   - 點擊 **「🔄 是，重新辨識」** 按鈕
   - **觀察行為**:
     - ✅ 顯示 spinner: "正在使用更新後的知識庫重新辨識..."
     - ✅ 辨識執行 (1-3 秒)
     - ✅ 顯示成功訊息: "✅ 重新辨識完成！處理時間: X.XX 秒"
     - ✅ 對話框消失
     - ✅ 「當前製程清單」更新為新的辨識結果
     - ✅ **重要**: 應該顯示 RAG 參考案例 (因為剛剛保存的就是參考案例)

6. **驗證圖片未丟失**:
   - ✅ 辨識使用的是**相同的圖片** (無需重新上傳)
   - ✅ 設定保持不變 (RAG, 幾何, 符號都仍啟用)

7. **測試拒絕重新辨識**:
   - 再次保存到知識庫 (如果需要，先調整製程)
   - 對話框再次出現
   - 點擊 **「❌ 不需要」** 按鈕
   - **觀察行為**:
     - ✅ 對話框立即消失
     - ✅ 不執行辨識
     - ✅ 「當前製程清單」保持不變

### 預期結果 (重新辨識)
```
✅ 重新辨識完成！處理時間: 1.45 秒

當前製程清單:
- F01 - 焊接 (信心度: 80%)  ← 信心度可能提高 (受 RAG 影響)
- D01 - 折彎 (信心度: 75%)

▼ 本次推論參考的歷史案例 (RAG Context)
參考案例：...
正確製程：F01, D01  ← 剛剛保存的案例
```

### 失敗情況
- ❌ 對話框不顯示 → Task 5 失敗
- ❌ 點擊「是，重新辨識」後出現錯誤 → Task 5 失敗
- ❌ 辨識時找不到圖片 (要求重新上傳) → 圖片未保存，Task 5 失敗
- ❌ 辨識設定改變 (例如 RAG 被關閉) → 設定未保存，Task 5 部分失敗
- ❌ 沒有顯示 RAG 參考案例 → RAG 未正確啟用，Task 1 或 Task 5 失敗
- ❌ 點擊「不需要」後對話框不消失 → Task 5 失敗

---

## 綜合測試流程 (推薦)

### 完整測試案例 (30 分鐘)

**情境**: 使用者第一次使用系統，保存案例到知識庫，然後驗證 RAG 效果

1. **啟動應用**: `streamlit run aov_app.py`

2. **首次辨識**:
   - 上傳 `test1.jpg`
   - ❌ 關閉 RAG (首次沒有知識庫)
   - ✅ 啟用幾何、符號
   - 執行辨識
   - 記錄結果 (製程清單、信心度)

3. **保存到知識庫 (Task 2, Task 5)**:
   - 調整製程: 加入 "F01", "D01"
   - 點擊「保存至知識庫」
   - **驗證**: 成功訊息顯示 "(1 張圖片)" → Task 2 ✅
   - **驗證**: 對話框顯示 → Task 5 ✅
   - 點擊「❌ 不需要」(暫時不重新辨識)

4. **啟用 RAG 並重新辨識 (Task 1)**:
   - ✅ 啟用 RAG (側邊欄)
   - 重新上傳 `test1.jpg` (相同圖片)
   - 執行辨識
   - **驗證**: 辨識正常完成 (VLM 關閉) → Task 1 ✅
   - **驗證**: 顯示 RAG 參考案例 → Task 1 ✅
   - 對比信心度: 應該提高 (受 RAG 影響)

5. **測試手動輸入 (Task 4)**:
   - 點擊「加入製程」
   - 選擇「手動輸入代碼或名稱」
   - 輸入 "o01" → **驗證**: 成功加入 "O01 - 鑽孔" → Task 4 ✅
   - 再次點擊「加入製程」
   - 輸入 "X99" (未知)
   - **驗證**: 顯示註冊表單 → Task 4 ✅
   - 輸入名稱 "特殊加工"，點擊「確認註冊」
   - **驗證**: 成功加入 → Task 4 ✅

6. **測試無重載 (Task 3)**:
   - 捲動到「待確認動作」
   - 點擊「刪除」按鈕
   - **驗證**: 製程立即消失，無頁面閃爍 → Task 3 ✅

7. **測試學習後重新辨識 (Task 5)**:
   - 調整製程清單
   - 點擊「保存至知識庫」
   - 點擊 **「🔄 是，重新辨識」**
   - **驗證**: 辨識完成，清單更新 → Task 5 ✅
   - **驗證**: 顯示 RAG 參考案例 (2 個案例) → Task 1 + Task 5 ✅

8. **測試多圖保存 (Task 2)**:
   - 上傳 3 張不同圖片
   - 執行辨識
   - 點擊「保存至知識庫」
   - **驗證**: 成功訊息顯示 "(3 張圖片)" → Task 2 ✅
   - 檢查 `knowledge_db.json` 和 `knowledge_images/` → Task 2 ✅

---

## 測試檢查清單

### Task 1: RAG 獨立運作
- [ ] RAG 在 VLM 關閉時可正常啟用 (UI)
- [ ] 辨識執行無錯誤
- [ ] 顯示 RAG 參考案例區塊
- [ ] 參考案例包含正確資訊

### Task 2: 多圖保存
- [ ] 上傳多張圖片成功
- [ ] 成功訊息顯示正確數量
- [ ] `knowledge_db.json` 包含 `additional_images` 欄位
- [ ] `knowledge_images/` 目錄包含所有圖片

### Task 3: 無頁面重載
- [ ] 加入製程時無頁面閃爍
- [ ] 刪除製程時無頁面閃爍
- [ ] 捲動位置保持不變

### Task 4: 手動輸入
- [ ] 輸入已知代碼成功加入
- [ ] 輸入已知名稱成功加入
- [ ] 輸入未知代碼顯示註冊表單 (要求名稱)
- [ ] 輸入未知名稱顯示註冊表單 (要求代碼)
- [ ] 註冊新製程成功加入

### Task 5: 學習後確認
- [ ] 保存後顯示確認對話框
- [ ] 對話框包含兩個按鈕
- [ ] 點擊「是」執行重新辨識
- [ ] 重新辨識使用相同圖片和設定
- [ ] 製程清單更新為新結果
- [ ] 點擊「否」對話框消失，不執行辨識

---

## 錯誤排查

### 錯誤 1: ModuleNotFoundError
```
ModuleNotFoundError: No module named 'paddleocr'
```
**解決**: 
- 關閉 OCR 功能 (側邊欄)
- 或安裝 PaddlePaddle: `pip install paddlepaddle paddleocr`

### 錯誤 2: RAG 不顯示
```
無 "本次推論參考的歷史案例 (RAG Context)" 區塊
```
**檢查**:
1. RAG 是否啟用 (側邊欄)
2. 知識庫是否有資料 (`knowledge_db.json` 非空)
3. 上傳的圖片是否與知識庫中的圖片相似

### 錯誤 3: 重新辨識失敗
```
重新辨識時發生錯誤: 找不到上傳的圖片
```
**原因**: `st.session_state.uploaded_drawing` 丟失  
**解決**: 重新上傳圖片，再執行保存

### 錯誤 4: 手動輸入無反應
```
輸入代碼後無任何顯示
```
**檢查**:
1. 是否選擇「手動輸入代碼或名稱」單選按鈕
2. 是否按 Enter 或點擊執行按鈕
3. 檢查瀏覽器控制台是否有錯誤

---

## 測試報告模板

```markdown
# 測試報告 - 2026-02-13

## 測試環境
- OS: Windows 11 / macOS / Linux
- Python: 3.x.x
- Streamlit: 1.x.x
- 測試時間: YYYY-MM-DD HH:MM

## 測試結果

### Task 1: RAG 獨立運作
- [ ] 通過 / [ ] 失敗
- 問題描述: (如果失敗)

### Task 2: 多圖保存
- [ ] 通過 / [ ] 失敗
- 問題描述: (如果失敗)

### Task 3: 無頁面重載
- [ ] 通過 / [ ] 失敗
- 問題描述: (如果失敗)

### Task 4: 手動輸入
- [ ] 通過 / [ ] 失敗
- 問題描述: (如果失敗)

### Task 5: 學習後確認
- [ ] 通過 / [ ] 失敗
- 問題描述: (如果失敗)

## 整體評估
- [ ] 所有功能正常
- [ ] 部分功能有問題
- [ ] 需要重大修復

## 備註
(其他觀察或建議)
```

---

**測試完成後，請填寫測試報告並回報結果。**
